/**
 * Secret Sanitization Utility
 * Role: JULES (The Orchestrator)
 * Purpose: Validate Service Account JSON before GitHub injection.
 * Implementation: TS-Œõ3 Baseline
 */

const fs = require('fs');

const validateServiceAccount = (filePath) => {
  try {
    const rawData = fs.readFileSync(filePath, 'utf8');
    
    // Check for common copy-paste artifacts
    if (rawData.trim() !== rawData) {
      console.warn("‚ö†Ô∏è WARNING: Leading/Trailing whitespace detected. Sanitizing...");
    }

    const sanitizedData = rawData.trim();
    
    // Attempt parsing to verify integrity
    const json = JSON.parse(sanitizedData);

    const requiredKeys = [
      "type", "project_id", "private_key_id", "private_key", 
      "client_email", "client_id", "auth_uri", "token_uri"
    ];

    const missing = requiredKeys.filter(key => !json[key]);
    
    if (missing.length > 0) {
      throw new Error(`Missing required keys: ${missing.join(', ')}`);
    }

    console.log("‚úÖ SUCCESS: JSON substrate is valid and formatted correctly.");
    console.log(`üöÄ TARGET PROJECT_ID: ${json.project_id}`);
    console.log("\n--- [SENTINEL] COPY THE BLOCK BELOW FOR GITHUB SECRETS ---");
    process.stdout.write(sanitizedData);
    console.log("\n--- [SENTINEL] END OF CLEAN SUBSTRATE ---");

  } catch (error) {
    console.error("‚ùå ERROR: Malformed JSON substrate detected.");
    console.error(`Reason: ${error.message}`);
    process.exit(1);
  }
};

// Usage: node secret_sanitization.js path/to/key.json
const targetFile = process.argv[2];
if (!targetFile) {
  console.log("Usage: node secret_sanitization.js <path_to_json>");
} else {
  validateServiceAccount(targetFile);
}